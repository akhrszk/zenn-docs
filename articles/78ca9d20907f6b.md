---
title: "OAuth2.0èªå¯ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ãŸã®ã§è§£èª¬ã™ã‚‹â‘¢ã€å®Ÿè£…ç·¨ã€‘"
emoji: "ğŸ©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OAuth", "oauth2", "OIDC", "OpenID"]
published: true
---

# OAuth2.0ã¨ã¯

èªå¯ã®ãƒ•ãƒ­ãƒ¼ã‚’æ¨™æº–åŒ–ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
APIã‚’å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹ç­‰ã®éš›ã€OAuth2ã®ä»•æ§˜ã«å¾“ã£ã¦èªå¯ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚Œã°é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿å‡ºæ¥ã¾ã™ã€‚

[RFC6749](https://datatracker.ietf.org/doc/html/rfc6749) ã¯ **The OAuth 2.0 Authorization Framework** ã«ä»•æ§˜ãŒå®šç¾©ã•ã‚Œã¦ã¾ã™ã€‚
**OpenID Foundation Japan** æ§˜ã‚ˆã‚Šã€æ—¥æœ¬èªè¨³ã‚‚ã•ã‚Œã¦ã„ã‚‹ã®ã§[ã“ã¡ã‚‰](https://openid-foundation-japan.github.io/rfc6749.ja.html)ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

# å®Ÿè£…ç·¨ã«ã¤ã„ã¦

ã“ã¡ã‚‰ã®è¨˜äº‹ã§ã¯ã€[ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒª](https://github.com/akhrszk/oauth2-example-js)ã®å®Ÿè£…ã‚’è¦‹ãªãŒã‚‰è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚
ä»Šå›ã¯Node.jsã§å®Ÿè£…ã—ã¾ã—ãŸã€‚

# èªå¯ã®ãƒ•ãƒ­ãƒ¼

ä»¥ä¸‹ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§ã™ã€‚ã“ã®å›³ã‚’è¦‹ãªãŒã‚‰èª­ã¿é€²ã‚ã‚‹ã¨ã‚ˆã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ãã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

![OAuth2ãƒ•ãƒ­ãƒ¼](/images/oauth2-example/sequence-ciagram.png)

## èªå¯

èªå¯ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã¯[oauth2-example-js](https://github.com/akhrszk/oauth2-example-js)ã®**oauth2**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

èªå¯ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã¯ã€**/oauth2/authorize**ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
èªå¯ãƒšãƒ¼ã‚¸ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰¿èªã™ã‚‹ã¨ã€åŒã˜ã**/oauth2/authorize**ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã§ã¯`response_type`ã¯`code`ã®ã¿ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
`state`ã¯CSRFå¯¾ç­–ã®ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ã€‚

```js:OAuth2Route.js
router.get('/authorize', async (req, res) => {
  const {
    client_id: clientName,
    redirect_uri: redirectUri,
    response_type: responseType,
    email,
    pass,
    authorize,
    scope,
    state
  } = req.query
  const clientService = ClientService.sharedInstance
  const { client, scopes, redirectUris } = await clientService.findByName(
    clientName
  )
  if (!client) {
    res.status(403)
    res.send('Forbidden')
    return
  }
  if (!authorize) {
    // èªå¯ãƒšãƒ¼ã‚¸è¡¨ç¤º
    const appService = AppService.sharedInstance
    const app = await appService.findByClient(client)
    res.render('authorize', {
      app,
      scope,
      clientName,
      responseType,
      redirectUri,
      state
    })
    return
  }
  if (!redirectUris.map(({ uri }) => uri).includes(redirectUri)) {
    res.status(400)
    res.send('Invalid redirect_uri')
    return
  }
  const requestScopes = (typeof scope === 'string' ? scope : '').split(' ')
  const scopeChecked = (() => {
    const having = scopes.map(({ scope }) => scope)
    return requestScopes.every((v) => having.includes(v))
  })()
  if (!scopeChecked || responseType !== 'code') {
    const query = querystring.stringify({
      error: !scopeChecked
        ? 'invalid_scope'
        : responseType !== 'code'
          ? 'unsupported_response_type'
          : 'invalid_request'
    })
    res.redirect(`${redirectUri}?${query}`)
    return
  }
  const user = await LoginUsecase.execute({ email, pass })
  if (!user) {
    res.redirect('back')
    return
  }
  const authorizationService = AuthorizationService.sharedInstance
  const created = await authorizationService.createAuthorizationCode(
    client,
    requestScopes,
    user
  )
  if (!created) {
    const query = querystring.stringify({ error: 'invalid_request' })
    res.redirect(`${redirectUri}?${query}`)
    return
  }
  const { code } = created
  const query = querystring.stringify({ code, ...(state ? { state } : {}) })
  res.redirect(`${redirectUri}?${query}`)
})
```

`client_id`ãŒæ­£ã—ã„ã‹ã€`redirect_uri`ã€`scope`ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å€¤ã‹ã€ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚(`client_id`ã¯å†…éƒ¨å®Ÿè£…ã§ã¯`clientName`ã¨ã„ã†å¤‰æ•°åã§æ‰±ã£ã¦ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚)

æ¤œè¨¼ã«æˆåŠŸã—ãŸã‚‰`code`ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

`code`ã®ç™ºè¡Œã«æˆåŠŸã—ãŸã‚‰ã€æŒ‡å®šã•ã‚ŒãŸ`redirect_uri`ã«`code`ã‚’ã‚¯ã‚¨ãƒªã«å«ã‚ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ã®å ´åˆã€Errorã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã«é€šçŸ¥ã—ã¾ã™ã€‚Errorãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯OAuth2ã®ä»•æ§˜ã§ã„ãã¤ã‹å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚[RFC6749 4.1.2.1. Error Response](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2.1)

**`redirect_uri`ãŒä¸æ­£ãªå ´åˆã€ãã®`redirect_uri`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¦ã¯ã„ã‘ãªã„ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚**

# AccessTokenã®å–å¾—

**ã«ã‚ƒãƒ¼ã‚“**ã‚µãƒ¼ãƒãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œ`code`ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚(`code`ã¯ã‚¯ã‚¨ãƒªã§å—ã‘æ¸¡ã—ã—ã¾ã™ã€‚)
èªå¯ã‚³ãƒ¼ãƒ‰ã‹ã‚‰`access_token`ã‚’è¦æ±‚ã™ã‚‹å®Ÿè£…ã¯**nyan**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã®**routes/OAuth2Route.js**ã«ã‚ã‚Šã¾ã™ã€‚
`access_token`ã®å–å¾—ã«æˆåŠŸã—ãŸã‚‰ã€å–å¾—ã—ãŸ`access_token`ã‚’ä½¿ã£ã¦**ã¤ã¶ã‚„ãã£ãŸãƒ¼**ã®APIã®`/me`ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

```js:OAuth2Route.js
router.get('/callback', async (req, res) => {
  const { code, error } = req.query
  if (error) {
    res.send(error)
    return
  }
  const tsubuyakiService = TsubuyakiService.sharedInstance
  const data = await tsubuyakiService.getAccessToken(code)
  console.log('access_token', data)
  const user = await tsubuyakiService.getMe(data['access_token'])
  console.log('user', user)
  req.session.tsubuyakiAccessToken = data['access_token']
  req.session.tsubuyakiRefreshToken = data['refresh_token']
  // æœ‰åŠ¹æœŸé™ã¯jsã§å–ã‚Šæ‰±ã„ã‚„ã™ã„ã‚ˆã†ã«ãƒŸãƒªç§’ã§æŒã¤
  req.session.tsubuyakiAccessTokenExpires =
    Date.now() + data['expires_in'] * 1000
  res.redirect('/')
})
```

# AccessTokenã‚’ç™ºè¡Œ

`access_token`ç™ºè¡Œã®å®Ÿè£…ã¯**oauth2**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®**routes/OAuth2Route.js**ã«ã‚ã‚Šã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã§ã¯ã€`grant_type`ã¯`authorization_code`ã¨`refresh_token`ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
`authorization_code`ã¯ã€**èªå¯ã‚³ãƒ¼ãƒ‰**ã«ã‚ˆã‚‹`access_token`å–å¾—ã§ã€`refresh_token`ã¯**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**ã«ã‚ˆã‚‹`access_token`ã®æ›´æ–°ã§ã™ã€‚

```js:OAuth2Route.js
router.post('/token', async (req, res) => {
  const {
    grant_type: grantType,
    code,
    refresh_token: refreshToken,
    client_id: clientName,
    client_secret: clientSecret,
    redirect_uri: redirectUri
  } = req.body
  if (grantType === 'authorization_code') {
    if (!code || !clientName || !clientSecret || !redirectUri) {
      res.status(400)
      res.json({ error: 'invalid_request' })
      return
    }
    const created = await GenerateAccessTokenUsecase.execute({
      clientName,
      clientSecret,
      redirectUri,
      code
    })
    if (!created) {
      res.status(400)
      res.json({ error: 'invalid_client' })
      return
    }
    const { accessToken, refreshToken, scopes } = created
    res.json({
      token_type: 'beare',
      access_token: accessToken.token,
      expires_in: ACCESS_TOKEN_EXPIRES_IN,
      refresh_token: refreshToken.token,
      scope: scopes
        .sort((a, b) => a - b)
        .map(({ scope }) => scope)
        .join(' ')
    })
  } else if (grantType === 'refresh_token') {
    if (!refreshToken || !clientName || !clientSecret) {
      res.status(400)
      res.json({ error: 'invalid_request' })
      return
    }
    const refreshed = await RefreshAccessTokenUsecase.execute({
      refreshToken,
      clientName,
      clientSecret
    })
    if (!refreshed) {
      res.status(400)
      res.send('invalid_request')
      return
    }
    const { accessToken, scopes } = refreshed
    res.json({
      token_type: 'beare',
      access_token: accessToken.token,
      expires_in: ACCESS_TOKEN_EXPIRES_IN,
      scope: scopes
        .sort((a, b) => a - b)
        .map(({ scope }) => scope)
        .join(' ')
    })
  } else {
    res.status(400)
    res.json({ error: 'unsupported_grant_type' })
  }
})
```

`access_token`ã®ç™ºè¡Œã«ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å—ã‘å–ã‚Šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èªè¨¼ã—ã¾ã™ã€‚ãã—ã¦ã€**èªå¯ã‚³ãƒ¼ãƒ‰**ãŒãã®èªè¨¼ã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ç´ã¥ãã‚‚ã®ã§ã‚ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
ã“ã®ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã«**èªå¯ã‚³ãƒ¼ãƒ‰**ãŒç›—ã¾ã‚Œã¦ã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒåˆ†ã‹ã‚‰ãªã„ã¨`access_token`ã‚’ç›—ã¿å‡ºã™ã“ã¨ãŒå‡ºæ¥ãªããªã‚Šã¾ã™ã€‚(**é€†ã«ã“ã®ãƒã‚§ãƒƒã‚¯ãŒæŠœã‘ã¦ã—ã¾ã†ã¨`access_token`ã‚’ä¸æ­£ã«å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã£ã¦ã—ã¾ã„é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ«ã«ãªã£ã¦ã—ã¾ã†ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚**)

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ãªå ´åˆãªã©ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯**application/json**ã§è¿”ã—ã¾ã™ã€‚Errorãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯OAuth2ã®ä»•æ§˜ã§ã„ãã¤ã‹å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚[RFC6749 5.2. Error Response](https://datatracker.ietf.org/doc/html/rfc6749#section-5.2)

# AccessTokenã‚’ä½¿ã£ã¦ã¤ã¶ã‚„ãã£ãŸãƒ¼ã«æŠ•ç¨¿ã™ã‚‹

ã„ã‚ˆã„ã‚ˆå®Ÿéš›ã«`access_token`ã‚’ä½¿ã£ã¦ã€**ã¤ã¶ã‚„ãã£ãŸãƒ¼**ã®APIã‚’å©ãã¾ã™ã€‚
ã«ã‚ƒãƒ¼ã‚“ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã€**ã«ã‚ƒãƒ¼ã‚“**ã‚µãƒ¼ãƒãƒ¼ã®APIã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚
ãã“ã§å—ã‘å–ã£ãŸ`message`ã‚’**ã¤ã¶ã‚„ãã£ãŸãƒ¼**ã®ã‚µãƒ¼ãƒãƒ¼ã«`access_token`ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»˜ä¸ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚

```js:NyanRoute.js
router.post('/', refreshAccessTokenIfNeed(), async (req, res) => {
  const { message } = req.body
  const accessToken = req.session.tsubuyakiAccessToken
  if (!accessToken) {
    res.status(401)
    res.send('Unauthorized')
    return
  }
  const tsubuyakiService = TsubuyakiService.sharedInstance
  const { data } = await tsubuyakiService.send(message, accessToken)
  console.log('Successfully sent to Tsubuyaki API', data)
  res.status(204)
  res.send()
})
```

**ã¤ã¶ã‚„ãã£ãŸãƒ¼**ã®APIã®å®Ÿè£…ã¯ä»¥ä¸‹ã§ã™ã€‚**tsubuyaki**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã®**routes/api/IndexRoute.js**ã«ã‚ã‚Šã¾ã™ã€‚
å—ã‘å–ã£ãŸ`access_token`ã«`write`æ¨©é™ãŒã‚ã‚‹ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€ã‚ã‚Œã°ã€`access_token`ã«ç´ã¥ã‘ã‚‰ã‚Œã¦ã„ã‚‹**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã§ã¤ã¶ã‚„ãã‚’DBã«ä¿å­˜ã—ã¾ã™ã€‚
å—ã‘å–ã£ãŸ`access_token`ã®æƒ…å ±ã®å–å¾—æ–¹æ³•ã¯ä»¥ä¸‹ã§èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

```js:IndexRoute.js
router.post(
  '/status',
  authorization({ required: ['read', 'write'] }),
  async (req, res) => {
    const { user } = req.authorization
    const { body } = req.body
    const status = await SaveStatusUsecase.execute({ user, status: { body } })
    res.json(status)
  }
)
```

# AccessTokenã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹

`access_token`ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯`/introspection`ã§ã™ã€‚
ãã®å®Ÿè£…ã¯**oauth2**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®**routes/IndexRoute.js**ã«ã‚ã‚Šã¾ã™ã€‚
ï¼ˆæ³¨æ„ç‚¹ã¨ã—ã¦ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å†…éƒ¨å‘ã‘ã«ã®ã¿å…¬é–‹ã•ã‚Œã‚‹ã¹ãã§ã™ã€‚æœ¬ç•ªé‹ç”¨ã§ã¯å¤–éƒ¨ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã¯åˆ‡ã‚Šé›¢ã—ã¾ã—ã‚‡ã†ã€‚ï¼‰

```js:IndexRoute.js
/* å†…éƒ¨å‘ã‘API */
router.post('/introspection', async (req, res) => {
  const { token } = req.body
  const introspection = await IntrospectionUsecase.execute({ token })
  if (introspection) {
    res.json({
      active: true,
      ...introspection
    })
  } else {
    res.json({
      active: false
    })
  }
})
```

**/introspection**ã«curlã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚Šã¾ã™ã€‚

```
$ curl -X POST -d token=<ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³> http://localhost:9001/introspection
{
  "active":true,
  "sub":"1",
  "aud":"http://tsubuyaki.test/",
  "iss":"http://oauth2.nyan.test/",
  "exp":1636835816,
  "iat":1636832216,
  "scope":"read write"
}
```

`access_token`ã®æƒ…å ±ã®å–å¾—ã¯middlewareã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
ãã®å®Ÿè£…ã¯ã€**tsubuyaki**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã®**middleware/AuthorizationMiddleware.js**ã«ã‚ã‚Šã¾ã™ã€‚
ä¸Šã§ç´¹ä»‹ã—ãŸ`/introspection`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§`access_token`ã‚’æ¸¡ã—ã€`access_tokenæƒ…å ±`ã‚’å–å¾—ã—ã¾ã™ã€‚

éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªtokenã ã£ãŸå ´åˆã‚„ã‚µãƒ¼ãƒãƒ¼ã«å­˜åœ¨ã—ãªã„tokenã ã£ãŸå ´åˆã€ `{ active: false }` ã ã‘è¿”ã—ã€ãã‚Œä»¥å¤–æƒ…å ±ã¯è¿”ã™ã¹ãã§ã¯ãªã„ã§ã™ã€‚ [RFC7662 2.3.  Error Response](https://datatracker.ietf.org/doc/html/rfc7662#section-2.3)

OAuth2ã® **Token Introspection** ã«ã¤ã„ã¦ã¯ã€[RFC7662](https://datatracker.ietf.org/doc/html/rfc7662) ã«ä»•æ§˜ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è©³ã—ãã¯ãã¡ã‚‰ã‚’å‚ç…§ã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚


å–å¾—ã—ãŸå€¤ã¯ãã‚Œãã‚Œä»¥ä¸‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

ã‚­ãƒ¼ | èª¬æ˜
---|---
sub | ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­)
aud | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å—ã‘æ‰‹
iss | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œè€…(èªå¯ã‚µãƒ¼ãƒãƒ¼ã®URL)
exp | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™
iat | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒç™ºè¡Œæ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
scope | èªå¯ã•ã‚ŒãŸæ¨©é™ã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¡¨ç¤º


```js:AuthorizationMiddleware.js
const authorization = (options) => {
  const requiredScopes = options?.required
  return async (req, res, next) => {
    const { token } = ((authorization) => {
      const kv = new Map([authorization?.split(' ') ?? []])
      return { token: kv.get('Bearer') }
    })(req.headers['authorization'])
    if (!!requiredScopes && !token) {
      res.status(401)
      res.send('Unauthorized')
      return
    }
    if (!requiredScopes && !token) {
      next()
      return
    }
    const { active, sub, scope } = await tokenIntrospection(token)
    if (!active && !!requiredScopes) {
      res.status(403)
      res.send('Forbidden')
      return
    }
    if (!active) {
      next()
      return
    }
    const user = await models.User.findByPk(sub)
    if (!user && !!requiredScopes) {
      res.status(403)
      res.send('Forbidden')
      return
    }
    if (!user) {
      next()
      return
    }
    const having = scope.split(' ')
    if (!requiredScopes.every((scope) => having.includes(scope))) {
      res.status(403)
      res.send('Forbidden')
      return
    }
    req.authorization = {
      user,
      scope: having
    }
    next()
  }
}

const tokenIntrospection = async (token) => {
  const res = await axios.post(
    'http://oauth2:3000/introspection',
    querystring.stringify({ token })
  )
  return res.data
}
```

ä»¥ä¸ŠãŒèªå¯ã‚µãƒ¼ãƒãƒ¼ã«å¿…è¦ãªå®Ÿè£…ã§ã™ã€‚

# è¨˜äº‹ä¸€è¦§

https://zenn.dev/akhr_s/articles/11331882be7b8d

https://zenn.dev/akhr_s/articles/bc75705d3438fc

https://zenn.dev/akhr_s/articles/78ca9d20907f6b
