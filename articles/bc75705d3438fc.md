---
title: "OAuth2.0èªå¯ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ãŸã®ã§è§£èª¬ã™ã‚‹â‘¡ã€è¨­è¨ˆç·¨ã€‘"
emoji: "ğŸ©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OAuth", "oauth2", "OIDC", "OpenID"]
published: true
---

# OAuth2.0ã¨ã¯

èªå¯ã®ãƒ•ãƒ­ãƒ¼ã‚’æ¨™æº–åŒ–ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
APIã‚’å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹ç­‰ã®éš›ã€OAuth2ã®ä»•æ§˜ã«å¾“ã£ã¦èªå¯ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚Œã°é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿å‡ºæ¥ã¾ã™ã€‚

[RFC6749](https://datatracker.ietf.org/doc/html/rfc6749) ã¯ **The OAuth 2.0 Authorization Framework** ã«ä»•æ§˜ãŒå®šç¾©ã•ã‚Œã¦ã¾ã™ã€‚
**OpenID Foundation Japan** æ§˜ã‚ˆã‚Šã€æ—¥æœ¬èªè¨³ã‚‚ã•ã‚Œã¦ã„ã‚‹ã®ã§[ã“ã¡ã‚‰](https://openid-foundation-japan.github.io/rfc6749.ja.html)ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

# è¨­è¨ˆç·¨ã«ã¤ã„ã¦

ã“ã¡ã‚‰ã®è¨˜äº‹ã§ã¯ã€OAuth2èªå¯ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã£ã¦ã€[ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒª](https://github.com/akhrszk/oauth2-example-js)ã‚’ä¾‹ã«DBã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã‚„ä»•æ§˜ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

# èªå¯ã®ãƒ•ãƒ­ãƒ¼

ä»¥ä¸‹ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§ã™ã€‚ã“ã®å›³ã‚’è¦‹ãªãŒã‚‰èª­ã¿é€²ã‚ã‚‹ã¨ã‚ˆã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ãã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

![OAuth2ãƒ•ãƒ­ãƒ¼](/images/oauth2-example/sequence-ciagram.png)

# ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```
mysql> show tables;
+----------------------------+
| Tables_in_tsubuyaki        |
+----------------------------+
| access_tokens              |
| apps                       |
| apps_scopes                |
| authorization_codes        |
| authorization_codes_scopes |
| clients                    |
| redirect_uris              |
| refresh_tokens             |
| schema_migrations          |
| scopes                     |
| statuses                   |
| users                      |
+----------------------------+
```

### ERå›³

![ERå›³](/images/oauth2-example/er-diagram.png)

ã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½•ã®å½¹å‰²ã‚’æœãŸã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

# App

èªå¯ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ä¾‹ã§ã¯ã€**ã«ã‚ƒãƒ¼ã‚“**ã‚µãƒ¼ãƒãƒ¼ã‚’ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã—ã¾ã™ã€‚

```
mysql> desc apps;
+------------+-------------+------+-----+-------------------+-----------------------------+
| Field      | Type        | Null | Key | Default           | Extra                       |
+------------+-------------+------+-----+-------------------+-----------------------------+
| id         | int(11)     | NO   | PRI | NULL              | auto_increment              |
| name       | varchar(25) | NO   |     | NULL              |                             |
| user_id    | int(11)     | NO   | MUL | NULL              |                             |
| deleted_at | datetime    | YES  |     | NULL              |                             |
| created_at | datetime    | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at | datetime    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+------------+-------------+------+-----+-------------------+-----------------------------+
```

ä»¥ä¸‹ã§ç™»å ´ã™ã‚‹`client`ã¯ã“ã®`app`ã«å¸°å±ã—ã¾ã™ã€‚

# Client

**OAuth2**ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ(**ã«ã‚ƒãƒ¼ã‚“**ã‚µãƒ¼ãƒãƒ¼)ã®èªå¯ã®é€šä¿¡ã¯ã€ã“ã®Clientã§èªè¨¼(`Client ID`, `Client Secret`)ã—ãŸä¸Šã§è¡Œã„ã¾ã™ã€‚

```
mysql> desc clients;
+------------+-------------+------+-----+-------------------+-----------------------------+
| Field      | Type        | Null | Key | Default           | Extra                       |
+------------+-------------+------+-----+-------------------+-----------------------------+
| id         | int(11)     | NO   | PRI | NULL              | auto_increment              |
| name       | varchar(25) | NO   | UNI | NULL              |                             |
| secret     | varchar(50) | NO   | UNI | NULL              |                             |
| app_id     | int(11)     | NO   | MUL | NULL              |                             |
| deleted_at | datetime    | YES  |     | NULL              |                             |
| created_at | datetime    | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at | datetime    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+------------+-------------+------+-----+-------------------+-----------------------------+
```

`Client ID`ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯`name`ã¨ã„ã†ã‚«ãƒ©ãƒ åã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚(å‹¿è«–ã€`id`ã«`Client ID`ã‚’å…¥ã‚Œã‚‹è¨­è¨ˆã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€ä»Šå›ã¯ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ã‚­ãƒ¼ã¯numberã«ã—ã¾ã—ãŸã€‚)

ã‚«ãƒ©ãƒ |èª¬æ˜
--|--
id|Primary Key
name|Client ID
secret|Client Secret

# RedirectURIã¨Scope

RedirectURIã¯èªå¯ç”»é¢ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹æ™‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã®**ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹**æ™‚ã«`èªå¯ã‚³ãƒ¼ãƒ‰`ã‚’å—ã‘å–ã‚‹ã“ã¨ã«ãªã‚‹é‡è¦ãªURLã§ã™ã€‚


```
mysql> desc redirect_uris;
+------------+--------------+------+-----+-------------------+-----------------------------+
| Field      | Type         | Null | Key | Default           | Extra                       |
+------------+--------------+------+-----+-------------------+-----------------------------+
| id         | int(11)      | NO   | PRI | NULL              | auto_increment              |
| app_id     | int(11)      | NO   | MUL | NULL              |                             |
| uri        | varchar(255) | NO   |     | NULL              |                             |
| created_at | datetime     | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at | datetime     | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+------------+--------------+------+-----+-------------------+-----------------------------+
```

`scope`ã¨ã¯èªå¯ã™ã‚‹**æ¨©é™**ã®ã“ã¨ã§ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã§ã¯ã€`scope`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯æœ€åˆã‹ã‚‰`read`ã¨`write`ã®å€¤ãŒå…¥ã£ã¦ã¾ã™ã€‚

```
mysql> desc scopes;
+------------+--------------+------+-----+-------------------+-----------------------------+
| Field      | Type         | Null | Key | Default           | Extra                       |
+------------+--------------+------+-----+-------------------+-----------------------------+
| id         | int(11)      | NO   | PRI | NULL              | auto_increment              |
| scope      | varchar(255) | NO   |     | NULL              |                             |
| deleted_at | datetime     | YES  |     | NULL              |                             |
| created_at | datetime     | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at | datetime     | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+------------+--------------+------+-----+-------------------+-----------------------------+

mysql> select * from scopes;
+----+-------+------------+---------------------+---------------------+
| id | scope | deleted_at | created_at          | updated_at          |
+----+-------+------------+---------------------+---------------------+
|  1 | read  | NULL       | 2021-11-03 11:12:37 | 2021-11-03 11:12:37 |
|  2 | write | NULL       | 2021-11-03 11:12:42 | 2021-11-03 11:12:42 |
+----+-------+------------+---------------------+---------------------+
```

```
mysql> desc apps_scopes;
+----------+---------+------+-----+---------+-------+
| Field    | Type    | Null | Key | Default | Extra |
+----------+---------+------+-----+---------+-------+
| app_id   | int(11) | NO   | PRI | NULL    |       |
| scope_id | int(11) | NO   | PRI | NULL    |       |
+----------+---------+------+-----+---------+-------+
```

# AuthorizationCode

ç™ºè¡Œã•ã‚ŒãŸ`èªå¯ã‚³ãƒ¼ãƒ‰`ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚`èªå¯ã‚³ãƒ¼ãƒ‰`ã¨ã¯ã€èªå¯ç”»é¢ã‹ã‚‰RedirectURIã«æˆ»ã£ãŸæ™‚ã«å—ã‘å–ã‚‹`code`ã§ã™ã€‚

#### `is_used`

`èªå¯ã‚³ãƒ¼ãƒ‰`ã¯ä¸€åº¦ã—ã‹ä½¿ãˆãªã„ã®ã§ã€ä½¿ã‚ã‚ŒãŸã‚‰å¿…ãš`is_used`ã‚’`true`ã«ã—ã€ï¼’å›ç›®ä»¥é™ã¯ä½¿ãˆãªã„ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### `client_id`

`authorization_code`ã‹ã‚‰`access_token`ã‚’ç™ºè¡Œã™ã‚‹éš›ã€Clientã‚’èªè¨¼ã—ã€authorization_codeã«ç´ã¥ãClientã‹ç¢ºèªã™ã‚‹ã®ã«å¿…è¦ã§ã™ã€‚

#### `user_id`

**ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹èªå¯**ã‹ã‚’ä¿å­˜ã—ã¾ã™ã€‚

```
mysql> desc authorization_codes;
+------------+-------------+------+-----+-------------------+-----------------------------+
| Field      | Type        | Null | Key | Default           | Extra                       |
+------------+-------------+------+-----+-------------------+-----------------------------+
| id         | int(11)     | NO   | PRI | NULL              | auto_increment              |
| client_id  | int(11)     | NO   | MUL | NULL              |                             |
| code       | varchar(50) | NO   | UNI | NULL              |                             |
| user_id    | int(11)     | NO   | MUL | NULL              |                             |
| is_used    | tinyint(1)  | NO   |     | 0                 |                             |
| created_at | datetime    | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at | datetime    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+------------+-------------+------+-----+-------------------+-----------------------------+
```

ä»¥ä¸‹ã¯`authorization_code`ã¨`scope`ã‚’çµã³ã¤ã‘ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã©ã®æ¨©é™ã‚’èªå¯ã•ã‚ŒãŸã®ã‹**ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

```
mysql> desc authorization_codes_scopes;
+-----------------------+---------+------+-----+---------+-------+
| Field                 | Type    | Null | Key | Default | Extra |
+-----------------------+---------+------+-----+---------+-------+
| authorization_code_id | int(11) | NO   | PRI | NULL    |       |
| scope_id              | int(11) | NO   | PRI | NULL    |       |
+-----------------------+---------+------+-----+---------+-------+
```

# AccessTokenã¨RefreshToken

`èªå¯ã‚³ãƒ¼ãƒ‰`ã®æ¤œè¨¼ãŒæˆåŠŸã—ãŸã‚‰ã€`access_token`ã‚’ç™ºè¡Œã—ã¾ã™ã€‚`access_token`ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®`refresh_token`ã‚‚ä¸€ç·’ã«ç™ºè¡Œã—ã¾ã™ã€‚


#### `client_id`

`access_token`, `refresh_token`ãŒã©ã®Clientã«ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ãªã®ã‹ä¿å­˜ã—ã¾ã™ã€‚
ç‰¹ã«ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹æ™‚ã€Clientã®èªè¨¼ã‚’è¡Œã„ã€`refresh_token`ãŒãã®Clientã«ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ™‚ã«å¿…è¦ã§ã™ã€‚ [RFC6749 10.4. Refresh Tokens](https://datatracker.ietf.org/doc/html/rfc6749#section-10.4)

#### `authorization_code_id`

`access_token`ã¯ã©ã®**æ¨©é™**ãŒèªå¯ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€`authorization_code`ã®`id`ã‚’æŒã£ã¦ã„ã¾ã™ã€‚(`refresh_token`ã‚‚åŒæ§˜ã«ã©ã®**æ¨©é™**ã‚’æŒã£ãŸ`access_token`ã‚’ç™ºè¡Œã™ã‚‹ã‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚`authorization_code`ã®`id`ã‚’æŒã¡ã¾ã™ã€‚)

#### `is_revoked`

`access_token`ã¨`refresh_token`ã¯ç„¡åŠ¹ã«ã™ã‚‹APIã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ç„¡åŠ¹ã«ã•ã‚ŒãŸã‹ã©ã†ã‹ã¯`is_revoked`ã‚«ãƒ©ãƒ ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

```
mysql> desc access_tokens;
+-----------------------+-------------+------+-----+-------------------+-----------------------------+
| Field                 | Type        | Null | Key | Default           | Extra                       |
+-----------------------+-------------+------+-----+-------------------+-----------------------------+
| id                    | int(11)     | NO   | PRI | NULL              | auto_increment              |
| client_id             | int(11)     | NO   | MUL | NULL              |                             |
| token                 | varchar(50) | NO   | UNI | NULL              |                             |
| user_id               | int(11)     | NO   | MUL | NULL              |                             |
| authorization_code_id | int(11)     | NO   | MUL | NULL              |                             |
| is_revoked            | tinyint(1)  | NO   |     | 0                 |                             |
| created_at            | datetime    | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at            | datetime    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+-----------------------+-------------+------+-----+-------------------+-----------------------------+

mysql> desc refresh_tokens;
+-----------------------+-------------+------+-----+-------------------+-----------------------------+
| Field                 | Type        | Null | Key | Default           | Extra                       |
+-----------------------+-------------+------+-----+-------------------+-----------------------------+
| id                    | int(11)     | NO   | PRI | NULL              | auto_increment              |
| client_id             | int(11)     | NO   | MUL | NULL              |                             |
| token                 | varchar(50) | NO   | UNI | NULL              |                             |
| user_id               | int(11)     | NO   | MUL | NULL              |                             |
| authorization_code_id | int(11)     | NO   | MUL | NULL              |                             |
| is_revoked            | tinyint(1)  | NO   |     | 0                 |                             |
| created_at            | datetime    | NO   |     | CURRENT_TIMESTAMP |                             |
| updated_at            | datetime    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+-----------------------+-------------+------+-----+-------------------+-----------------------------+
```

#### `access_token`ã¨`refresh_token`ã®æœ‰åŠ¹æœŸé™ã«ã¤ã„ã¦

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã§ã¯ã€`access_token`ã®æœ‰åŠ¹æœŸé™ã¯`created_at`ã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
ä»Šå›ã®å®Ÿè£…ã§ã¯ã€`access_token`ã®æœ‰åŠ¹æœŸé™ã¯ç™ºè¡Œã•ã‚Œã¦ã‹ã‚‰60åˆ†é–“ã«ã—ã¦ã„ã¾ã™ã€‚`refresh_token`ã¯ã€æœ‰åŠ¹æœŸé™ã¯ãªãã€æ˜ç¤ºçš„ã«revokeã—ãªã„é™ã‚Šæ°¸ä¹…ã«ä½¿ç”¨å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚
`access_token`ã®æœ‰åŠ¹æœŸé™ãŒéããŸã‚‰ã€`refresh_token`ã‚’ä½¿ã£ã¦æ–°ãŸã«`access_token`ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

# è¨˜äº‹ä¸€è¦§

https://zenn.dev/akhr_s/articles/11331882be7b8d

https://zenn.dev/akhr_s/articles/bc75705d3438fc

https://zenn.dev/akhr_s/articles/78ca9d20907f6b
