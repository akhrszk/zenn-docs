---
title: "GraphQLã¨ã‚³ãƒ¼ãƒ‰ã‚¸ã‚§ãƒ¬ãƒ¼ã‚¿ã§ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªé–‹ç™º"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["graphql", "apollo", "react", "javascript", "typescript"]
published: true
---

> ### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’çµåˆãƒ†ã‚¹ãƒˆï¼ ...å‹•ã‹ãªã„ï¼›ï¼›

ã¿ãŸã„ãªæ‰‹æˆ»ã‚Šã¯æœ€å°é™ã«æŠ‘ãˆã€åŠ¹ç‡çš„ãªé–‹ç™ºã‚’è¡Œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªé–‹ç™ºã«ã¤ã„ã¦ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã¾ã™ã€‚

https://github.com/akhrszk/schema-first-development-with-graphql

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

#### TypeScript

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å…±ã« TypeScript ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

#### GraphQL.js

GraphQL ã® JavaScript ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

https://graphql.org/graphql-js/

#### React

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯`create-react-app`ã§ä½œã‚Šã¾ã—ãŸã€‚

https://create-react-app.dev/

#### Apollo GraphQL Client

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® GraphQL ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦[Apollo](https://www.apollographql.com/docs/react/)ã‚’ä½¿ã„ã¾ã™ã€‚
ä»¥ä¸‹ã§ç´¹ä»‹ã™ã‚‹[GraphQL Code Generator](https://www.graphql-code-generator.com/)ã§ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ React hooks ã‚’ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

https://www.apollographql.com/docs/react/

#### Fastify

ã‚µãƒ¼ãƒãƒ¼ã¯ã€[Fastify](https://www.fastify.io/)ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚ã¾ãŸã€Fastify ã§ GraphQL ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹ã®ã«[mercurius](https://mercurius.dev/)ã¨ã„ã† Adapter ã‚’ä½¿ã„ã¾ã™ã€‚

https://www.fastify.io/

#### GraphQL Code Generator

ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‹ã‚‰ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://www.graphql-code-generator.com/docs/getting-started

#### Prisma

DB ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚prisma ã¯ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’ã‚‚ã¨ã« Client ã‚’ç”Ÿæˆã—ãŸã‚Šã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ãŸã‚Šã€CLI ã‚³ãƒãƒ³ãƒ‰ãŒå……å®Ÿã—ã¦ã„ã¾ã™ã€‚

https://www.prisma.io/

# GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

[ã‚µãƒ³ãƒ—ãƒ«ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/akhrszk/schema-first-development-with-graphql)ã§ã¯ã€backend/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

```graphql:schema.graphql
scalar DateTime

type Post {
  id: Int!
  title: String!
  content: String
  published: Boolean!
  author: User
  viewCount: Int!
  createdAt: DateTime!
}

type User {
  id: Int!
  email: String!
  name: String
}

type Query {
  allUsers: [User!]!
  draftsByUser(input: UserUniqueInput): [Post!]
  feed(q: String, sort: FeedSort, skip: Int, take: Int): [Post!]!
}

type Mutation {
  createDraft(authorEmail: String!, data: PostCreateInput!): Post
  deletePost(id: Int!): Post
  incrementPostViewCount(id: Int!): Post
  signup(data: UserCreateInput!): User
  togglePublishPost(id: Int!): Post
}

enum SortOrder {
  asc
  desc
}

input UserUniqueInput {
  email: String
  id: Int
}

input FeedSort {
  updatedAt: SortOrder!
}

input PostCreateInput {
  title: String!
  content: String
}

input UserCreateInput {
  email: String!
  name: String
}
```

ã“ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’ã‚‚ã¨ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã¨ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚’ãã‚Œãã‚Œå®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

### `graphql-codegen`ã§ Resolver ã®å‹ã‚’ç”Ÿæˆ

ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã« GraphQL Code Generator ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

https://www.graphql-code-generator.com/docs/guides/graphql-server-apollo-yoga#guide

GraphQL Code Generator ã§è‡ªå‹•ç”Ÿæˆã™ã‚‹ã®ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ä½¿ã£ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€ `@graphql-codegen/typescript` `@graphql-codegen/typescript-resolvers` ã§ã™ã€‚

##### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```yaml:codegen.yml
overwrite: true
schema: "./schema.graphql"
generates:
  src/lib/generated/graphql.ts:
    plugins:
      - typescript
      - "typescript-resolvers"
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Resolver ã®å‹ã‚’ç”Ÿæˆã—ã¾ã™

```bash
yarn graphql-codegen --config codegen.yml
```

### Resolver ã‚’å®Ÿè£…

Resolver ã®å‹ãŒç”Ÿæˆã•ã‚ŒãŸã‚‰ã€ãã‚Œã‚’ã‚‚ã¨ã«å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```typescript:resolvers.ts
export const resolvers: Resolvers<Context> = {
  Query: {
    allUsers: (_parent, _args, context, _info) => {
      return context.prisma.user.findMany()
    },
    ...
  },
  Mutation: {
    ...
  }
}
```

PrismaClient ã‚’ Context ã‚’é€šã—ã¦ Resolver ã§å—ã‘å–ã‚Šã¾ã™ã€‚
Context ã®å®Ÿè£…ã¯ä»¥ä¸‹ã€‚

```typescript:context.ts
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
})

export interface Context {
  prisma: PrismaClient
}

export const context: Context = {
  prisma
}

export const buildContext = async (
  _req: FastifyRequest,
  _reply: FastifyReply
): Promise<Context> => {
  return { prisma }
}
```

ã‚µãƒ¼ãƒãƒ¼ã¯ Fastify ã‚’ä½¿ã„ã¾ã—ãŸã€‚Fastify ã§ GraphQL ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã®ã«[mercurius](https://mercurius.dev/)ã¨ã„ã† Adapter ã‚’ä½¿ã„ã¾ã™ã€‚
ä¸Šã§å®Ÿè£…ã—ãŸ`context`ã¨`resolvers`ã‚‚ä¸€ç·’ã«æ¸¡ã—ã¾ã™ã€‚

```typescript:server.ts
import { resolvers } from './resolvers'
import { buildContext } from './context'

// Load schema from the file
const schema = loadSchemaSync(join(__dirname, '../schema.graphql'), {
  loaders: [new GraphQLFileLoader()]
})

// Add resolvers to the schema
const schemaWithResolvers = addResolversToSchema({
  schema, resolvers
})

const fastify = Fastify()

fastify.register(mercurius, {
  schema: schemaWithResolvers,
  context: buildContext,
  graphiql: true
})

fastify.listen(4000, '0.0.0.0', (err, addr) => {
  if (err) {
    console.error(err)
    process.exit(1)
  }
  console.info(`Server listening on ${addr}`)
})
```

ã‚ã£ã¨ã„ã†é–“ã« GraphQL ã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè£…å‡ºæ¥ã¡ã‚ƒã„ã¾ã—ãŸã­

server.ts ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€GraphQL ã‚µãƒ¼ãƒãƒ¼ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

GraphiQL ã‚‚ç«‹ã¡ä¸ŠãŒã‚‹è¨­å®šã«ã—ã¦ã‚ã‚‹ã®ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã® URL ã§é–‹ãã¾ã™

```
http://localhost:4000/graphiql
```

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…ã‚’å§‹ã‚ã‚‹å‰ã«ã€ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã™ã€‚
ApolloServer ã‚’ä½¿ã†ã“ã¨ã§ GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ãŠæ‰‹è»½ã«ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‰ã‚Œã¾ã™ã€‚

### ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‹ã‚‰ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’

[ã‚µãƒ³ãƒ—ãƒ«ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/akhrszk/schema-first-development-with-graphql)ã§ã¯ frontend/mock/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

```typescript:server.ts
// Load schema from the file
const schema = loadSchemaSync(join(__dirname, '../../server/schema.graphql'), {
  loaders: [new GraphQLFileLoader()]
})

const server = new ApolloServer({
  schema,
  mocks: true
})

server.listen().then(({ url }) =>
  console.log(`ğŸš€ Server ready at ${url}`)
)
```

server.ts ã‚’å®Ÿè¡Œã—ãŸã‚‰ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã® URL ã‹ã‚‰ ApolloStudio ã‚’é–‹ã‘ã¾ã™ã€‚

```
http://localhost:4000
```

#### `graphql-codegen`ã§ Apollo ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨åŒã˜ã‚ˆã†ã« GraphQL Code Generator ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã„ãªãŒã‚‰é€²ã‚ã¾ã—ãŸã€‚

https://www.graphql-code-generator.com/docs/guides/react#typed-hooks-for-apollo-and-urql

ä½¿ã£ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ `@graphql-codegen/typescript` `@graphql-codegen/typescript-operations` `@graphql-codegen/typescript-react-apollo` ã§ã™ã€‚

`@graphql-codegen/typescript-react-apollo` ã¯ ApolloClient ã® React hooks ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚
ä»Šå›ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€hooks ä»¥å¤–ã«ã‚‚ Component ã‚„ HOC ãªã©ã‚‚ç”Ÿæˆå‡ºæ¥ãŸã‚Šã€ãã®ä»–ã®è¨­å®šã‚‚è±Šå¯Œã«ç”¨æ„ã•ã‚Œã¦ã‚ã‚Šã€ä¾¿åˆ©ãã†ã§ã™ã€‚è©³ã—ãã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã€‚

https://www.graphql-code-generator.com/plugins/typescript-react-apollo

##### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```yaml:codegen.yml
overwrite: true
schema: "../backend/schema.graphql"
documents: "graphql/**/*.graphql"
generates:
  src/graphql/types.ts:
    plugins:
      - "typescript"
      - "typescript-operations"
      - "typescript-react-apollo"
```

##### documents

documents ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ãã«ç™ºè¡Œã™ã‚‹ã‚¯ã‚¨ãƒªã‚’å®šç¾©ã—ã¾ã™ã€‚
[ã‚µãƒ³ãƒ—ãƒ«ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/akhrszk/schema-first-development-with-graphql)ã§ã¯ã€frontend/graphql/ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

```graphql:post.graphql
query feed($q: String!, $take: Int, $skip: Int, $sort: SortOrder!) {
  feed(q: $q, sort: { updatedAt: $sort }, take: $take, skip: $skip) {
    id
    title
    content
    viewCount
    createdAt
    author {
      id
      name
    }
  }
}
```

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã™ã‚‹ã¨ã€ApolloClient ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãƒ•ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™

```bash
yarn graphql-codegen --config codegen.yml
```

### GraphQL ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè£…

ä¸Šã®ã‚³ãƒãƒ³ãƒ‰ã§`useFeedQuery`ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
ã“ã‚Œã‚’ä½¿ã£ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚

```typescript:Feed.tsx
export const Feed: React.FC<FeedProps> = ({ q, take, skip, sort }) => {
  const { loading, error, data } = useFeedQuery({
    variables: { q, take, skip, sort }
  })
  if (loading) {
    return (<div>loading...</div>)
  }
  if (error) {
    return (<div>{error.message}</div>)
  }
  const posts = data?.feed ?? []
  return (
    <div className='Feed'>
      {posts.map((post) => (
        <div className='Feed-Row'>
          <a className='Feed-Row-Title' href='/'>{post.title}</a>
          {' '}
          <span className='Post-Views'>{post.viewCount}views</span>
          <div>
            <span className='Post-Author'>author: {post.author?.name}</span>
            {' '}
            <DateTime className='Post-DateTime' datetime={post.createdAt} />
          </div>
        </div>
      ))}
    </div>
  )
}
```

# å‹•ä½œãƒã‚§ãƒƒã‚¯

ã“ã¡ã‚‰ã®[ã‚µãƒ³ãƒ—ãƒ«](https://github.com/akhrszk/schema-first-development-with-graphql)ã§ã¯ã€docker-compose ã§ç«‹ã¡ä¸ŠãŒã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```bash
docker-compose up
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§`http://localhost:3000`ã‚’é–‹ã„ã¦ã¿ã¾ã™ã€‚

![localhost_3000.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2255107/e61148cc-46f7-b21b-2440-1b499cda0cb1.png)

ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºå‡ºæ¥ã¦ã„ã¾ã™ã­ï¼

ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ï¼Ÿã‚³ãƒ¼ãƒ‰ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§å‹å®‰å…¨ã«é–‹ç™ºãŒé€²ã‚ã‚‰ã‚Œã€å°šä¸”ã¤å¤§å¹…ã«å®Ÿè£…é‡ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒå‡ºæ¥ã¾ã—ãŸã­ï¼

# èª²é¡Œ

ä»¥ä¸Šã§æ¦‚ã­å‹å®‰å…¨ã«å®Ÿè£…å‡ºæ¥ãŸã®ã§ã™ãŒã€æ®‹å¿µãªãŒã‚‰å®Œå…¨ã«ã¯å‹å®‰å…¨ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ã€‚ã€‚
å•é¡Œã¯ã€schema.graphql ã§å®šç¾©ã—ãŸ custom scalar ã®`DateTime`ã§ã™ã€‚

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ [graphql-scalars](https://github.com/Urigo/graphql-scalars) ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ resolvers ã§ DateTimeResolver ã‚’æ¸¡ã—ã¦ã‚„ã‚‹ã“ã¨ã§ã€serialize ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚

```typescript:resolvers.ts
export const resolvers: Resolvers<Context> = {
  ...,
  DateTime: DateTimeResolver,
}
```

ä¸€æ–¹ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ GraphQL Code Generator ã§ç”Ÿæˆã•ã‚ŒãŸå‹ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€DateTime ãŒ any å‹ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

```typescript:types.ts
export type Scalars = {
  ID: string;
  String: string;
  Boolean: boolean;
  Int: number;
  Float: number;
  DateTime: any; //â†ã“ã‚Œ
};
```

custom scalar ã® DateTime ã‚’ deserialize ã—ã¦ Date å‹ã«å¤‰æ›ã™ã‚‹å‡¦ç†ã‚‚ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã—ã¦æ¬²ã—ã„ã®ã§ã™ãŒã€ã©ã†ã™ã‚Œã°ã„ã„ã®ã‹åˆ†ã‹ã‚‰ãšã€‚ã€‚ã€‚
ç¾çŠ¶æ–¹æ³•ãªã„ã‚“ã§ã—ã‚‡ã†ã‹ã­ã€ã€ã€ï¼Ÿ
