---
title: "Prismaã¨Pothosã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ä½¿ã„ãªãŒã‚‰åŠ¹ç‡ã‚ˆãGraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã£ã¦ã¿ã‚‹"
emoji: "ğŸª´"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["graphql", "prisma", "pothos"]
published: false
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’Pothosã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

ã¨ã“ã‚ã§çš†ã•ã‚“ã¯[Pothos](https://pothos-graphql.dev/)ã‚’ã”å­˜çŸ¥ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã©ã‚“ãªã‚‚ã®ã‹ã¨ã„ã†ã¨ã€ã„ã‚ã‚†ã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªé–‹ç™ºã‚’æ‰‹åŠ©ã‘ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚åŒã˜ã‚ˆã†ãªã‚‚ã®ã¨ã—ã¦ã¯Nexusãªã‚“ã‹ãŒæœ‰åã§ã™ã­ã€‚[Prismaã®å…¬å¼ã‚µã‚¤ãƒˆ](https://www.prisma.io/graphql)ã§ã‚‚Nexusã‚’ä½¿ã£ãŸé–‹ç™ºã‚’ç´¹ä»‹ã—ã¦ã¾ã™ã‚ˆã­ã€‚
ãŸã ã€Nexusã¯æœ€è¿‘é–‹ç™ºãŒã»ã¼æ­¢ã¾ã£ã¦ã—ã¾ã£ã¦ã„ã¦ä¸ç©ãªé›°å›²æ°—ãŒæ¼‚ã£ã¦ã„ã¾ã™ã€‚

ãã“ã§ã€ãªã«ã‹ä»£æ›¿ã§ãã‚‹ã‚‚ã®ã¯ãªã„ã‹ã¨æ¢ã—ã¦ã¿ãŸã¨ã“ã‚ã€PothosãŒè‰¯ã•ãã†ã ã£ãŸã®ã§ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€**Prismaã¨ã®çµ±åˆ**ã€**Pothos Pluginsã‚’ä½¿ã£ã¦Relayæº–æ‹ ãƒ»èªè¨¼èªå¯**ã®å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯ä»¥ä¸‹ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«ä¸Šã’ã¦ã¾ã™ã€‚

https://github.com/akhrszk/prisma-pothos-example

# é–‹ç™ºç’°å¢ƒæ§‹ç¯‰

```sh
pnpm init

# TypeScriptã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -D typescript ts-node @types/node
pnpm tsc --init

# eslintã®è¨­å®š
npm init @eslint/config
âœ” How would you like to use ESLint? Â· style
âœ” What type of modules does your project use? Â· commonjs
âœ” Which framework does your project use? Â· none
âœ” Does your project use TypeScript? Â· No / Yes
âœ” Where does your code run? Â· browser
âœ” How would you like to define a style for your project? Â· guide
âœ” Which style guide do you want to follow? Â· standard-with-typescript
âœ” What format do you want your config file to be in? Â· JavaScript

# prettierå°å…¥
pnpm add -D prettier eslint-config-prettier
```

```sh
pnpm add -D npm-run-all
```

# Prismaã‚’å…¥ã‚Œã‚‹

```sh
pnpm add -D prisma
pnpm prisma init
```

é©å½“ã«ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã¾ã™ã€‚ä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯PostgreSQLã‚’ä½¿ã„ã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ä½œã‚‹ã‚‚ã®ã¯ã€ãƒãƒ¼ãƒ ã§ä½¿ã†ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã¾ã™ã€‚**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½**ã€**ãƒ­ãƒ¼ãƒ«ï¼ˆç®¡ç†è€…/ãƒ¡ãƒ³ãƒãƒ¼ï¼‰**ã€**è¨˜äº‹ã®ä½œæˆ**ã€**è¨˜äº‹ã®ãƒ‰ãƒ©ãƒ•ãƒˆ/å…¬é–‹ã®è¨­å®šæ©Ÿèƒ½**ãªã©ã‚’å‚™ãˆã¦ã¾ã™ã€‚

```prisma:prisma/prisma.schema
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // Generate into custom location because this repo has multiple prisma schemas
  output   = "./client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MEMBER
  ADMIN
}

enum PostStatus {
  DRAFT
  PUBLIC
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique @db.VarChar(255)
  name  String @db.VarChar(255)
  role  Role   @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  password Password?
  posts    Post[]
}

model Password {
  userId Int  @id
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  hashed String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id      Int        @id @default(autoincrement())
  title   String     @db.VarChar(255)
  content String
  status  PostStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId Int
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}
```

Prismaã®ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›¸ã‘ãŸã‚‰Prisma Clientã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```sh
pnpm prisma generate
```

# Pothosã‚’å…¥ã‚Œã‚‹

`@pothos/plugin-prisma`ã¯Prismaã¨é€£æºã™ã‚‹ãŸã‚ã«pluginã§ã™ã€‚ã•ã‚‰ã«Relayæº–æ‹ ã«ã™ã‚‹ãŸã‚ã«`@pothos/plugin-relay`ã‚‚å…¥ã‚Œã¾ã™ã€‚

```sh
pnpm add @pothos/core @pothos/plugin-prisma @pothos/plugin-relay
```

**prisma.schema**ã«Pothosç”¨ã®è¨­å®šã‚’æ›¸ãåŠ ãˆã¦ã€generateã—ã¾ã™ã€‚

```diff prisma:prisma/prisma.schema
+ generator pothos {
+   provider     = "prisma-pothos-types"
+   // Match client output location from above
+   clientOutput = "./client"
+   output       = "./generated.d.ts"
+ }
```

```sh
pnpm prisma generate
```

Pothosã§ä½¿ã†ãŸã‚ã®å‹ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

# Seedãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹

ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«[Faker](https://github.com/faker-js/faker)ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```sh
pnpm add -D @faker-js/faker
```

Prismaã®Seedæ©Ÿèƒ½ã‚’ä½¿ã£ã¦å…¥ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```ts:prisma/seed.ts
import { type PostStatus, PrismaClient } from "./client";
import { faker } from "@faker-js/faker";
import { hashPassword } from "../src/utils";

const prisma = new PrismaClient();

async function main() {
  const users = Array.from({ length: 10 })
    .map((_, i) => ({
      id: i + 1,
      email: faker.internet.email(),
      name: faker.person.fullName(),
    }));
  const posts = Array.from({ length: 30 })
    .map((_, i) => ({
      id: i + 1,
      title: faker.lorem.sentence(),
      content: faker.lorem.paragraph(),
      status: Math.floor(Math.random() * 10) % 4 === 0 ? "DRAFT" : "PUBLIC",
      authorId: Math.floor(Math.random() * 10) + 1,
    }));

  const hashedPassword = await hashPassword("password");

  await Promise.all(users.map(user =>
    prisma.user.upsert({
      where: { id: user.id },
      update: {},
      create: {
        id: user.id,
        email: user.email,
        name: user.name,
        password: {
          create: {
            hashed: hashedPassword,
          }
        }
      },
    })
  ));

  await Promise.all(posts.map(post => prisma.post.upsert({
      where: { id: post.id },
      update: {},
      create: {
        id: post.id,
        title: post.title,
        content: post.content,
        status: post.status as PostStatus,
        authorId: post.authorId,
      },
    })
  ));
}

main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    process.exit(1);
  });
```

Prismaã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦seedãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¾ã™ã€‚

```sh
pnpm prisma db seed
```

å®Ÿè¡Œå‡ºæ¥ãŸã‚‰ã€Prisma Studioã§ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã‚‹ã“ã¨ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```sh
pnpm prisma studio
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Prisma Studio is up on http://localhost:5555
```

# Prismaã¨Pothosã®çµ±åˆ

ã“ã“ã¾ã§å‡ºæ¥ãŸã‚‰ã„ã‚ˆã„ã‚ˆPothosã§GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## Prisma Client

```ts:src/db.ts
import { Prisma, PrismaClient } from "../prisma/client";

export const prisma = new PrismaClient({
  log:
    process.env.NODE_ENV === "production"
      ? ["warn", "error"]
      : ["query", "info", "warn", "error"],
});
```

Prisma Clientã‚’Contextã«ç½®ãã®ã¯VSCodeã®å‹ãƒã‚§ãƒƒã‚¯ã‚’é‡ãã™ã‚‹ãŸã‚éæ¨å¥¨ã ãã†ãªã®ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§æ‰±ã„ã¾ã™ã€‚

[https://pothos-graphql.dev/docs/plugins/prisma#set-up-the-builder](https://pothos-graphql.dev/docs/plugins/prisma#set-up-the-builder)

> It is strongly recommended NOT to put your prisma client into Context. This will result in slower type-checking and a laggy developer experience in VSCode. See this issue for more details.

## Pothosã®ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€

ä»Šå›åˆ©ç”¨ã™ã‚‹ PrismaPlugin ã¨ RelayPlugin ã‚’ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ã«æ¸¡ã—ã¾ã™ã€‚

```ts:src/builder.ts
import SchemaBuilder from "@pothos/core";
import PrismaPlugin from "@pothos/plugin-prisma";
import RelayPlugin from "@pothos/plugin-relay";
import type PrismaTypes from "../prisma/generated";
import { prisma } from "./db";

export const builder = new SchemaBuilder<{
  PrismaTypes: PrismaTypes;
}>({
  plugins: [PrismaPlugin, RelayPlugin],
  relayOptions: {},
  prisma: {
    client: prisma,
    dmmf: Prisma.dmmf,
  },
});

builder.queryType();
builder.mutationType();

```

## Pothosã§ãƒªã‚¾ãƒ«ãƒã‚’å®šç¾©

`prismaNode()` ã‚„ `prismaConnection()` ã‚„ `relatedConnection()` ã‚’ä½¿ã†ã“ã¨ã§Relayæº–æ‹ ã«ãªã£ã¦ãã‚Œã¾ã™ã€‚

Relayæº–æ‹ ãªã®ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹IDã¯ä¸€æ„ãªã‚°ãƒ­ãƒ¼ãƒãƒ«IDã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚`encodeGlobalID`/`decodeGlobalID()`ã‚’ä½¿ã†ã“ã¨ã§æ‰‹å‹•ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

```ts:src/schema.ts
import { decodeGlobalID } from "@pothos/plugin-relay";
import { builder } from "./builder";
import { prisma } from "./db";

builder.prismaNode("User", {
  id: { field: "id" },
  findUnique: (id) => {
    const { id: rawID } = decodeGlobalID(id);
    return { id: Number.parseInt(rawID, 10) };
  },
  fields: (t) => ({
    name: t.exposeString("name"),
    posts: t.relatedConnection("posts", {
      cursor: "id",
      totalCount: true,
    }),
  }),
});

builder.prismaNode("Post", {
  id: { field: "id" },
  findUnique: (id) => {
    const { id: rawID } = decodeGlobalID(id);
    return { id: Number.parseInt(rawID, 10) };
  },
  fields: (t) => ({
    title: t.exposeString("title"),
    content: t.exposeString("content"),
    author: t.relation("author"),
  }),
});

builder.queryFields((t) => ({
  post: t.prismaField({
    type: "Post",
    nullable: true,
    args: {
      id: t.arg.id({ required: true }),
    },
    resolve: async (query, _, args) => {
      const { id } = decodeGlobalID(args.id as string);
      return await prisma.post.findUnique({
        ...query,
        where: { id: parseInt(id, 10) },
      });
    },
  }),
  posts: t.prismaConnection({
    type: "Post",
    cursor: "id",
    resolve: async (query) => await prisma.post.findMany({ ...query }),
  }),
}));

// ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ã§GraphQLã‚¹ã‚­ãƒ¼ãƒã‚’ç”Ÿæˆã™ã‚‹ã€‚
export const schema = builder.toSchema();
```

ã“ã‚Œã ã‘ã§Relayæº–æ‹ ã®Connectionã‚’è¿”ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã‚ˆã­ã€‚

# GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹

ä½•ã§ã‚‚è‰¯ã„ã®ã§ã™ãŒä»Šå›ã¯ [GraphQL Yoga](https://github.com/dotansimha/graphql-yoga) ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

```sh
pnpm add graphql-yoga
```

ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ã‹ã‚‰ç”Ÿæˆã—ãŸSchemaã‚’æ¸¡ã—ã¦GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚Šã¾ã™ã€‚

```ts:src/main.ts
import { createServer } from 'node:http'
import { createYoga } from "graphql-yoga"
import { schema } from "./schema"

const yoga = createYoga({
  schema,
})

const server = createServer(yoga)

const port = process.env.PORT || "3000";

server.listen(port, () => {
  console.info(
    `Server is running on http://localhost:${port}${yoga.graphqlEndpoint}`,
  );
});
```

æ›¸ã‘ãŸã‚‰GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã™ã€‚

```sh
pnpm ts-node src/main.ts
Server is running on http://localhost:3000/graphql
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨GraphiQLã‚’é–‹ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

![GraphiQL ScreenShot](/images/prisma-pothos-example/graphiql.png)

# ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–ã«bcryptã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯JWTã‚’ä½¿ã„ã¾ã™ã€‚

```sh
pnpm add bcrypt jsonwebtoken
pnpm add -D @types/bcrypt @types/jsonwebtoken
```

ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Cookieã«ä¿å­˜ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

GraphQL Yogaã®[Cookiesãƒ—ãƒ©ã‚°ã‚¤ãƒ³](https://the-guild.dev/graphql/yoga-server/docs/features/cookies)ã‚’ä½¿ã„ã¾ã™ã€‚

```sh
pnpm add @whatwg-node/server-plugin-cookies
```

```diff ts:src/main.ts
  const yoga = createYoga({
    schema,
+   plugins: [useCookies()],
  });
```

## Contextã‚’å®šç¾©

Contextã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ã€‚Contextã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦Schema Builderã§æ¸¡ã—ã¾ã™ã€‚

```ts:src/context.ts
import { type YogaInitialContext } from "graphql-yoga";
import { type User } from "../prisma/client";

export interface Context extends YogaInitialContext {
  user?: User;
}
```

```diff ts:src/builder.ts
  export const builder = new SchemaBuilder<{
    PrismaTypes: PrismaTypes;
+   Context: Context;
  }>({
    plugins: [PrismaPlugin, RelayPlugin],
    relayOptions: {},
    prisma: {
      client: prisma,
    },
});
```

## ãƒ­ã‚°ã‚¤ãƒ³Mutationã‚’å®Ÿè£…

Simple Objects Pluginã‚’ä½¿ã„ã¾ã™ã€‚

```sh
pnpm add @pothos/plugin-simple-objects
```

```diff ts:src/builder.ts
  export const builder = new SchemaBuilder<{
    PrismaTypes: PrismaTypes;
    Context: Context;
  }>({
-   plugins: [PrismaPlugin, RelayPlugin],
+   plugins: [PrismaPlugin, RelayPlugin, SimpleObjectsPlugin],
    relayOptions: {},
    prisma: {
      client: prisma,
    },
  });
```

ãƒ­ã‚°ã‚¤ãƒ³Mutationã®æˆ»ã‚Šå€¤ã®Objectã®å®šç¾©ã¨ãƒ­ã‚°ã‚¤ãƒ³Mutationã®å‡¦ç†ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```ts:src/schema.ts
const LoginType = builder.simpleObject("Login", {
  fields: (t) => ({
    token: t.string({ nullable: false }),
  }),
});

builder.mutationFields((t) => ({
  login: t.field({
    type: LoginType,
    args: {
      email: t.arg.string({ required: true }),
      password: t.arg.string({ required: true }),
    },
    resolve: async (_, args, ctx) => {
      const userWithPassword = await prisma.user.findUnique({
        where: { email: args.email },
        include: { password: true },
      });
      if (!userWithPassword || !userWithPassword.password) {
        throw new Error("Failed login");
      }
      const isVerifiedPassword = await verifyPassword({
        rawPassword: args.password,
        hashedPassword: userWithPassword.password.hashed,
      });
      if (!isVerifiedPassword) {
        throw new Error("Failed login");
      }
      const token = jwtSign(userWithPassword.id);
      await ctx.request.cookieStore?.set(CookieKeys.authToken, token);
      return { token };
    },
  }),
}));
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’Contextã«æ¸¡ã™å‡¦ç†ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚Cookieã§æ¸¡ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦DBã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚

```diff ts:src/main.ts
  const yoga = createYoga({
    schema,
+   context: async (ctx) => {
+     const authToken =
+       ctx.request.headers.get("Authorization")?.split(" ")?.[1] ||
+       (await ctx.request.cookieStore?.get(CookieKeys.authToken))?.value;
+     if (!authToken) {
+       return { ...ctx };
+     }
+     const auth = jwtVerify(authToken);
+     const user = await prisma.user.findUnique({
+       where: { id: parseID(auth.sub!) },
+     });
+     return { ...ctx, user };
+   },
    plugins: [useCookies()],
  });
```

# èªå¯å‡¦ç†ã‚’è¡Œã†

Pothosã®[Auth Plugin](https://pothos-graphql.dev/docs/plugins/scope-auth)ã‚’ä½¿ã„ã¾ã™ã€‚

```sh
pnpm add @pothos/plugin-scope-auth
```

ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ã« `AuthScopes` ã®è¨­å®šã‚’è¿½è¨˜ã™ã‚‹ã€‚

```diff ts:src/builder.ts
  export const builder = new SchemaBuilder<{
+   AuthScopes: {
+     member: boolean;
+     admin: boolean;
+   };
    PrismaTypes: PrismaTypes;
    Context: Context;
  }>({
-   plugins: [PrismaPlugin, RelayPlugin, SimpleObjectsPlugin],
+   plugins: [ScopeAuthPlugin, PrismaPlugin, RelayPlugin, SimpleObjectsPlugin],
+   authScopes: async (ctx) => ({
+     admin: ctx.user?.role === "ADMIN",
+     member: ctx.user?.role === "MEMBER",
+   }),
    relayOptions: {},
    prisma: {
      client: prisma,
    },
  });
```

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¨­å®šã™ã‚‹ã€‚

```diff ts:src/schema.ts
  const User = builder.prismaNode("User", {
    id: { field: "id" },
    findUnique: (id) => ({ id: parseID(id) }),
    fields: (t) => ({
      name: t.exposeString("name"),
-     email: t.exposeString("email"),
+     email: t.exposeString("email", {
+       authScopes: { admin: true, member: true },
+     }),
      role: t.exposeString("role"),
      posts: t.relation("posts"),
    }),
  });
```

Queryã‚„Mutationã«å¯¾ã—ã¦ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¨­å®šã™ã‚‹ã€‚

```diff ts:src/schema.ts
  builder.mutationField("updateUserRole", (t) =>
    t.prismaField({
      type: User,
      args: {
        input: t.arg({ type: updateUserRoleInput, required: true }),
      },
+     authScopes: { admin: true },
      resolve: (query, _, { input }) =>
        prisma.user.update({
          ...query,
          where: { id: parseID(input.userId) },
          data: { role: input.role },
        }),
    }),
  );
```

# ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚«ãƒ©ãƒ¼ã‚’è¿½åŠ ã™ã‚‹

ä¾‹ã¨ã—ã¦ [graphql-scalars](https://github.com/Urigo/graphql-scalars) ã®DateTime Resolverã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

```diff ts:src/builder.ts
  export const builder = new SchemaBuilder<{
+   Scalars: {
+     DateTime: {
+       Input: Date;
+       Output: Date;
+     };
+   };
    Connection: {
      totalCount: number | (() => number | Promise<number>),
    },
    AuthScopes: {
      loggedIn: boolean;
      member: boolean;
      admin: boolean;
    };
    PrismaTypes: PrismaTypes;
    Context: Context;
  }>({
    plugins: [ScopeAuthPlugin, PrismaPlugin, RelayPlugin, SimpleObjectsPlugin],
    authScopes: async (ctx) => ({
      loggedIn: !!ctx.user,
      admin: ctx.user?.role === "ADMIN",
      member: ctx.user?.role === "MEMBER",
    }),
    relayOptions: {},
    prisma: {
      client: prisma,
      dmmf: Prisma.dmmf,
      filterConnectionTotalCount: true,
    },
  });

+ builder.addScalarType("Date", DateResolver, {});
```

updateAt ã¨ createdAt ã®å‹ã«DateTimeã‚’æŒ‡å®šã—ã¾ã™ã€‚

```diff ts:src/schema.ts
  builder.prismaNode("Post", {
    id: { field: "id" },
    findUnique: (id) => ({ id: parseID(id) }),
    fields: (t) => ({
      title: t.exposeString("title"),
      content: t.exposeString("content"),
      author: t.relation("author"),
+     createdAt: t.expose("createdAt", { type: "DateTime" }),
+     updatedAt: t.expose("updatedAt", { type: "DateTime" }),
    }),
  });
```

# ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯ç´¹ä»‹å‡ºæ¥ã¾ã›ã‚“ã§ã—ãŸãŒã€Query complexityã®Pluginã‚„Inputã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®Pluginãªã©ä»–ã«ã‚‚æ•°å¤šãã®PluginãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚‚ä¾¿åˆ©ãã†ã§æ°—ã«ãªã‚Šã¾ã™ã­ã€‚
ğŸ‘‰ [Pothos GraphQL Plugins](https://pothos-graphql.dev/docs/plugins)

ã©ã†ã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚è‡ªå‹•ç”Ÿæˆã‚’ã‚´ãƒªã‚´ãƒªã§ä½¿ã£ã¦æ¥½ãŒå‡ºæ¥ãã†ãªé›°å›²æ°—ã‚’å‘³ã‚ãˆãŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ã‚³ãƒ¼ãƒ‰ã‚’æ©Ÿæ¢°çš„ã«è‡ªå‹•ç”Ÿæˆã™ã‚‹ã“ã¨ã§äººã®å¤‰ãªãƒŸã‚¹ãŒæ··å…¥ã—ãªã„ã®ã§ã€ãƒã‚°ãŒèµ·ã“ã‚Šã«ããå®‰å…¨ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚‹ã“ã¨ã‚‚åˆ©ç‚¹ã§ã™ã‚ˆã­ã€‚

ãƒ—ãƒ­ã‚°ãƒ©ãƒã®3å¤§ç¾å¾³ã®ä¸€ã¤ã€Œæ€ æƒ°ã§ã‚ã‚Œã€ã«ã‚‚é€šãšã‚‹è©±ã§ã™ã‚ˆã­ã€‚